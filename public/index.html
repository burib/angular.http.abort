<!DOCTYPE html>
<html>
  <head>
  </head>

  <body>
    <div ng-app="queryApp" ng-controller="QueryCtrl">
      <input type="button" ng-click="send()" value="SendQuery"><br/>
      <input type="button" ng-click="cancel()" value="CancelQuery">
      <p>status: {{status}}</p>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.js"></script>
    <script>
      angular.module('queryApp', []).

      service('QueryService', function ($http, $q) {
        var deferred = null;
        return {
          cancelQuery: function () {
            deferred.resolve();
          },
          sendQuery: function (query) {
            /**
             * cancel previous request if there was any.
             */
            if (deferred) {
                this.cancelQuery();
            }
            deferred = $q.defer();
            return $http.
              get('/data', {
                timeout: deferred.promise
              }).
              then(function (response) {
                return response.data;
              });
          }
        }
      }).

      controller('QueryCtrl', function($scope, QueryService) {
        $scope.status = 'init';

        $scope.cancel = function () {
          $scope.status = 'canceled';
          QueryService.cancelQuery();
        };
        $scope.send = function () {
          $scope.status = 'loading...';
          QueryService.sendQuery().then(function () {
            $scope.status = 'done!';
          });
        };
      });

    </script>
  </body>

</html>
